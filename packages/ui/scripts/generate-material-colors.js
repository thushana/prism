/**
 * Generate colors CSS for Tailwind v4
 * 
 * This script reads from the material-ui-colors package and generates
 * a CSS file with all colors in Tailwind v4 @theme format.
 */

const colors = require('material-ui-colors');
const fs = require('fs');
const path = require('path');

// Convert camelCase to kebab-case
function toKebabCase(str) {
  return str.replace(/([A-Z])/g, '-$1').toLowerCase();
}

// Generate CSS content
function generateCSS() {
  let css = `/**
 * Color Palette for Tailwind CSS v4
 * 
 * Auto-generated from material-ui-colors package
 * Contains all colors with all shades (50-900, A100-A700)
 * 
 * Import this file in your Tailwind CSS configuration:
 * @import "@ui/styles/colors.css" layer(theme);
 */

@theme {
`;

  // Process each color
  const colorNames = Object.keys(colors).filter(name => name !== 'common');
  
  for (const colorName of colorNames) {
    const colorShades = colors[colorName];
    const kebabName = toKebabCase(colorName);
    
    // Add comment for color group
    css += `\n  /* ${colorName.charAt(0).toUpperCase() + colorName.slice(1).replace(/([A-Z])/g, ' $1')} */\n`;
    
    // Add all shades
    for (const [shade, hex] of Object.entries(colorShades)) {
      const shadeName = shade.startsWith('A') ? `a${shade.slice(1)}` : shade;
      css += `  --color-${kebabName}-${shadeName}: ${hex};\n`;
    }
  }

  css += '}\n';
  
  return css;
}

// Generate background utilities CSS
function generateBackgroundUtilities() {
  let css = `/**
 * Background utility classes for Material UI colors
 * Auto-generated from material-ui-colors package
 * 
 * Usage: background-red-500, background-blue-600, etc.
 */

@layer utilities {
`;

  const colorNames = Object.keys(colors).filter(name => name !== 'common');
  
  for (const colorName of colorNames) {
    const colorShades = colors[colorName];
    const kebabName = toKebabCase(colorName);
    
    for (const [shade, hex] of Object.entries(colorShades)) {
      const shadeName = shade.startsWith('A') ? `a${shade.slice(1)}` : shade;
      css += `  .background-${kebabName}-${shadeName} { background-color: var(--color-${kebabName}-${shadeName}); }\n`;
    }
  }

  css += '}\n';
  return css;
}

// Write the CSS files
const outputPath = path.join(__dirname, '../styles/colors.css');
const cssContent = generateCSS();

fs.writeFileSync(outputPath, cssContent, 'utf-8');
console.log(`✅ Generated colors CSS: ${outputPath}`);
console.log(`   Colors: ${Object.keys(colors).filter(name => name !== 'common').length}`);
console.log(`   Total shades: ${Object.values(colors).filter(c => typeof c === 'object').reduce((sum, c) => sum + Object.keys(c).length, 0)}`);

// Generate TypeScript color values lookup by parsing colors.css (single source of truth)
function generateColorValuesTS() {
  // Parse colors.css to extract hex values (avoids duplication)
  const cssContent = fs.readFileSync(outputPath, 'utf-8');
  const colorMap = new Map();
  
  // Extract color variables from CSS: --color-red-50: #ffebee;
  const varRegex = /--color-([a-z-]+)-(\d+|a\d+):\s*(#[0-9a-fA-F]+);/g;
  let match;
  
  while ((match = varRegex.exec(cssContent)) !== null) {
    const [, colorKebab, shade, hex] = match;
    // Convert kebab-case to camelCase: deep-purple -> deepPurple
    const colorName = colorKebab.replace(/-([a-z])/g, (_, letter) => letter.toUpperCase());
    // Store shade as number or string (a100, a200, etc.)
    const shadeKey = shade.startsWith('a') ? shade : parseInt(shade);
    
    if (!colorMap.has(colorName)) {
      colorMap.set(colorName, {});
    }
    colorMap.get(colorName)[shadeKey] = hex.toLowerCase();
  }
  
  // Maintain Material UI color order (not alphabetical)
  const materialColorOrder = ['red', 'pink', 'purple', 'deepPurple', 'indigo', 'blue', 'lightBlue', 'cyan', 'teal', 'green', 'lightGreen', 'lime', 'yellow', 'amber', 'orange', 'deepOrange', 'brown', 'grey', 'blueGrey'];
  const colorNames = Array.from(colorMap.keys()).sort((a, b) => {
    const indexA = materialColorOrder.indexOf(a);
    const indexB = materialColorOrder.indexOf(b);
    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
    if (indexA === -1) return 1;
    if (indexB === -1) return -1;
    return indexA - indexB;
  });
  
  let ts = `/**
 * Color hex values lookup table
 * Auto-generated by parsing colors.css (single source of truth)
 * 
 * Provides direct hex values for all shades - useful when CSS variables can't be used
 * (e.g., in charts, canvas, inline styles, or when you need computed values)
 * 
 * DO NOT EDIT MANUALLY - This file is auto-generated by scripts/generate-material-colors.js
 */

export type ColorName = ${colorNames.map(name => `"${name}"`).join(' | ')};

export const colorHexValues: Record<ColorName, Record<number | "a100" | "a200" | "a400" | "a700", string>> = {
`;

  for (const colorName of colorNames) {
    const shades = colorMap.get(colorName);
    ts += `  ${colorName}: { `;
    const shadeEntries = [];
    // Sort shades: numeric first, then a100, a200, a400, a700
    const sortedShades = Object.keys(shades).sort((a, b) => {
      if (typeof a === 'string' && typeof b === 'string') {
        const order = { 'a100': 0, 'a200': 1, 'a400': 2, 'a700': 3 };
        return (order[a] || 999) - (order[b] || 999);
      }
      if (typeof a === 'string') return 1;
      if (typeof b === 'string') return -1;
      return parseInt(a) - parseInt(b);
    });
    
    for (const shadeKey of sortedShades) {
      const key = typeof shadeKey === 'string' && shadeKey.startsWith('a') ? `"${shadeKey}"` : shadeKey;
      shadeEntries.push(`${key}: "${shades[shadeKey]}"`);
    }
    ts += shadeEntries.join(', ') + ' },\n';
  }

  ts += `} as const;\n`;
  return ts;
}

// Write background utilities
const utilitiesPath = path.join(__dirname, '../styles/background-utilities.css');
const utilitiesContent = generateBackgroundUtilities();
fs.writeFileSync(utilitiesPath, utilitiesContent, 'utf-8');
console.log(`✅ Generated background utilities CSS: ${utilitiesPath}`);

// Write TypeScript color values
const colorValuesPath = path.join(__dirname, '../styles/color-values.ts');
const colorValuesContent = generateColorValuesTS();
fs.writeFileSync(colorValuesPath, colorValuesContent, 'utf-8');
console.log(`✅ Generated color values TypeScript: ${colorValuesPath}`);
